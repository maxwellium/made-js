"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _arrayBufferToBase64(buffer){for(var binary="",bytes=new Uint8Array(buffer),len=bytes.byteLength,i=0;len>i;i++)binary+=String.fromCharCode(bytes[i]);return window.btoa(binary)}function _base64ToArrayBuffer(base64){var binary_string=window.atob(base64),len=binary_string.length;console.log(len);for(var bytes=new Uint8Array(len),i=0;len>i;i++)bytes[i]=binary_string.charCodeAt(i);return bytes}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj["default"]=obj,newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function storeFile($q,Made){return{restrict:"E",template:'<input type="file">',transclude:!0,scope:!1,link:function(scope,element,attrs){element.on("change",function(onChangeEvent){var filePromises=[],element=onChangeEvent.srcElement||onChangeEvent.target,bucket=[];Array.prototype.slice.call(element.files).forEach(function(file){var deferred=$q.defer(),reader=new FileReader;reader.onload=function(onLoadEvent){bucket.push(Made.fileFromData(file.name,onLoadEvent.target.result)),scope.$apply(),deferred.resolve()},reader.onabort=reader.onerror=function(error){console.log("madeStoreFileDirective, FileReader aborted:",error),deferred.reject(error)},filePromises.push(deferred.promise),reader.readAsArrayBuffer(file)}),$q.all(filePromises).then(function(){scope.$parent[attrs.callback](scope,bucket)})})}}}function topology(){var width=640,height=480,color=d3.scale.category20(),force=d3.layout.force().charge(-120).linkDistance(60).size([width,height]);return{restrict:"E",scope:{data:"="},link:function(scope,element){var svg=d3.select(element[0]).append("svg").attr("width",width).attr("height",height),nodes=null,links=null;scope.$watch("data",function(newVal){if(LOGGING&&console.log("made-topology nodes",newVal),svg.selectAll("*").remove(),newVal){nodes=newVal.nodes,links=newVal.links,force.nodes(nodes),force.links(links),force.start();var link=svg.selectAll(".topology-link").data(links).enter().append("line").attr("class","topology-link"),node=svg.selectAll(".topology-node").data(nodes).enter().append("circle").attr("class","topology-node").attr("r",15).style("fill",function(d){return color(d.type)}).call(force.drag);force.on("tick",function(){link.attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y}),node.attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y})})}})}}}function topologyLegend(){var color=d3.scale.category20();return{restrict:"E",scope:{data:"="},link:function(scope,element){var list=d3.select(element[0]).append("div");scope.$watch("data",function(newVal){LOGGING&&console.log("made-topology-legend nodes",newVal),list.selectAll("*").remove(),newVal&&list.selectAll("div").data(newVal.nodes).enter().append("div").text(function(d){return d.type}).append("div").attr("class","topology-legend-box").style("background-color",function(d){return color(d.type)})})}}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Channel=function(){function Channel(Made,uri,context){_classCallCheck(this,Channel),Object.assign(this,{Made:Made,uri:uri,context:context,buffer:[],listener:null}),this.Made.contexts[this.context]=this,this.Made.send_with_context("channel",{type:"open",uri:uri},this.context)}return _createClass(Channel,[{key:"send",value:function(data){return this.Made.send_with_context("channel",{type:"package","package":data},this.context)}},{key:"recv",value:function(){return this.buffer.shift()}},{key:"handleRecv",value:function(data){this.buffer.push(data),this.listener&&(this.listener.resolve(this.buffer.shift()),this.listener=null)}},{key:"asyncRecv",value:function(){return this.listener=this.Made.$q.defer(),this.listener.promise}},{key:"resolve",value:function(msg){console.log("channel-error",msg.error),this.handleClose()}},{key:"handleClose",value:function(){console.log("close channel "+this.context),delete this.Made.contexts[this.context],this.listener&&this.listener.resolve(null)}},{key:"close",value:function(){this.Made.send_with_context("channel",{type:"close"},this.context),this.handleClose()}}]),Channel}();exports["default"]=Channel,Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),File=function(){function File(Made,ctx){_classCallCheck(this,File),Object.assign(this,{Made:Made,ctx:ctx,seek:0,data:null})}return _createClass(File,[{key:"readAll",value:function(){var _this=this;return this.Made.request("rpc://crm/file/read",[this.ctx.filename]).then(function(result){return _this.data=_base64ToArrayBuffer(result.data)})}},{key:"read",value:function(pos,length){return this.Made.request("rpc://crm/file/read",[this.ctx.filename,pos,length]).then(function(result){return result.data})}},{key:"store",value:function(){function upload(idx){if(idx<me.data.byteLength){var chunk=me.data.slice(idx,idx+me.ctx.chunk_size),encoded=_arrayBufferToBase64(chunk);channel.send(encoded),setTimeout(function(){upload(idx+me.ctx.chunk_size)},300)}else channel.send("done-writing"),channel.asyncRecv().then(function(data){console.log("finished uploading"),me.ctx=data,defer.resolve()})}var me=this,defer=this.Made.$q.defer(),channel=this.Made.channel("file://crm/"+this.ctx.filename);return upload(0),defer.promise}},{key:"save",value:function(){var pom=document.createElement("a"),url=window.URL.createObjectURL(new Blob([this.data],{type:"octet/stream"}));if(pom.setAttribute("href",url),pom.setAttribute("download",this.ctx.filename),document.createEvent){var event=document.createEvent("MouseEvents");event.initEvent("click",!0,!0),pom.dispatchEvent(event)}else pom.click()}},{key:"remove",value:function(){return this.Made.request("rpc://crm/file/remove",[this.ctx.filename])}}]),File}();exports["default"]=File,require("angular-uuid4");var _made=require("made"),_made2=_interopRequireDefault(_made),_urlserviceprovider=require("urlserviceprovider"),_urlserviceprovider2=_interopRequireDefault(_urlserviceprovider),_storefile=require("storefile"),_storefile2=_interopRequireDefault(_storefile),_topology=require("topology"),topology=_interopRequireWildcard(_topology);angular.module("made-js",["uuid4","ngCookies"]).provider("madeUrlService",_urlserviceprovider2["default"]).service("Made",_made2["default"]).directive("madeStoreFile",_storefile2["default"]).directive("madeTopology",topology.topology).directive("madeTopologyLegend",topology.topologyLegend),Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_madeChannel=require("./madeChannel"),_madeChannel2=_interopRequireDefault(_madeChannel),_madeFile=require("./madeFile"),_madeFile2=_interopRequireDefault(_madeFile),Made=function(){function Made($q,$cookieStore,$rootScope,uuid4,madeUrlService){_classCallCheck(this,Made),Object.assign(this,{$q:$q,$cookieStore:$cookieStore,$rootScope:$rootScope,uuid4:uuid4,madeUrlService:madeUrlService,contexts:{},reconnectTimeout:1e3,user:null,wss:null}),this.setupSocket(),this.afterConnect=this.whenConnected}return _createClass(Made,[{key:"setupSocket",value:function(){this.wss=new WebSocket(this.madeUrlService()),this.user||(this.user=this.$cookieStore.get("user")),void 0===this.user&&(this.user=null),this.wss.onopen=function(){console.log("socket open!")},this.wss.onerror=function(errorEvent){console.log("socket error, event:",errorEvent)},this.wss.onclose=function(closeEvent){console.log("socket close, event:",closeEvent),setTimeout(this.setupSocket,this.reconnectTimeout),this.reconnectTimeout<12e4&&(this.reconnectTimeout*=2)},this.wss.onmessage=function(msg){switch(msg=JSON.parse(msg.data),msg.action){case"answer":msg.context in this.contexts?(msg.success?(this.contexts[msg.context].resolve(msg),"schema"===this.contexts[msg.context].action?console.log("++ received schema ++",this.contexts[msg.context].uri,msg.data.schema):console.log("++ received ++",this.contexts[msg.context].uri,msg.data,msg.error)):(console.log("-- received --"+(msg.error?"ERROR":""),this.contexts[msg.context].uri,msg),this.contexts[msg.context].reject&&(this.contexts[msg.context].reject(msg),this.$rootScope.$broadcast("made-error",msg)),"15c3ad4d828c5937a721893351c767fd"===msg.error.id&&(this.logout(),this.$rootScope.$broadcast("made-logout"))),delete this.contexts[msg.context]):console.log("made-js error: message for unknown context");break;case"channel":switch(console.log("-- received --"+(msg.error?"ERROR":""),msg),msg.data.type){case"open":console.log("!!!FATAL!!! Opening channel to browser not allowed!");break;case"package":msg.context in this.contexts?this.contexts[msg.context].handleRecv(msg.data["package"]):console.log("package for unknown channel");break;case"close":msg.context in this.contexts?this.contexts[msg.context].handleClose():console.log("close for unknown channel")}}}}},{key:"message",value:function(action,data){return{user:this.user,context:0,action:action,data:data,error:null,success:!0}}},{key:"whenConnected",value:function(callback){function wait(){console.log("made-js - wait for connect"),setTimeout(function(){this.whenConnected(callback)},750)}if(this.wss)switch(this.wss.readyState){case WebSocket.CONNECTING:wait();break;case WebSocket.OPEN:this.reconnectTimeout=1e3,callback();break;default:console.log("made-js: try to send over a closed socket!"),this.setupSocket(),wait()}else wait()}},{key:"send",value:function(action,data){var defer=this.$q.defer(),context=this.uuid4.generate();return this.contexts[context]=defer,this.send_with_context(action,data,context),defer.promise}},{key:"send_with_context",value:function(action,data,context){var _this=this,msg=this.message(action,data);msg.context=context,"request"==msg.action?(this.contexts[context].uri=msg.data.uri,console.log("-- sending --",msg.data.uri,msg.data.args,msg.data.kwargs)):"schema"===msg.action?(this.contexts[context].uri=msg.data,this.contexts[context].action=msg.action,console.log("-- schema --",msg.data)):console.log("-- sending --",msg.action,context);var encoded=angular.toJson(msg);this.whenConnected(function(){_this.wss.send(encoded)})}},{key:"request",value:function(uri,kwargs){"undefined"==typeof kwargs&&(kwargs={});var data={uri:uri,kwargs:kwargs};return this.send("request",data)}},{key:"channel",value:function(uri){return new _madeChannel2["default"](this,uri,this.uuid4.generate())}},{key:"topology",value:function(){return this.send("topology",{}).then(function(result){return result.data})}},{key:"capabilities",value:function(){return this.send("capabilities").then(function(result){return result.data})}},{key:"schema",value:function(url){return this.send("schema",url).then(function(result){return result.data})}},{key:"fileFromData",value:function(name,data){var ctx={filename:name,chunk_size:261120,length:data.byteLength,md5:"",encoding:"utf-8",meta:{}},file=new _madeFile2["default"](this,ctx);return file.data=data,file}},{key:"file",value:function(ctx){return new _madeFile2["default"](this,ctx)}},{key:"loginByName",value:function(user,password){var _this2=this;return this.request("rpc://crm/user/login",[],{user:user,password:password}).then(function(result){return _this2.login(result.data)})}},{key:"loginByEmail",value:function(email,password){var _this3=this;return this.request("rpc://crm/user/login",[],{email:email,password:password}).then(function(result){return _this3.login(result.data)})}},{key:"login",value:function(user){this.user=user,this.$cookieStore.put("user",this.user),this.$rootScope.$broadcast("made-login")}},{key:"logout",value:function(){this.user&&(this.request("rpc://crm/user/logout"),this.user=null,this.$cookieStore.put("user",null),this.$rootScope.$broadcast("made-logout"))}},{key:"isLoggedin",value:function(){return null!==this.user}}]),Made}();exports["default"]=Made,Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=storeFile,Object.defineProperty(exports,"__esModule",{value:!0}),exports.topology=topology,exports.topologyLegend=topologyLegend,Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),UrlServiceProvider=function(){function UrlServiceProvider(){_classCallCheck(this,UrlServiceProvider),this.protocol="ws://","https:"===window.location.protocol&&(this.protocol="wss://"),this.host=window.location.host,this.path="/ws"}return _createClass(UrlServiceProvider,[{key:"$get",value:function(){return this.url||(this.url=this.protocol+this.host+this.path),this.url}}]),UrlServiceProvider}();exports["default"]=UrlServiceProvider;