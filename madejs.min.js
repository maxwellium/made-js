function url(){var a="ws://";return"https:"===window.location.protocol&&(a="wss://"),a+window.location.host+"/ws"}function buildhtml(a,b){var c='<div class="row responsiv-md list">';for(name in a){var d=a[name];c+='<div class="col">',"object"!=typeof d?(c+='<label class="item item-input">',c+='    <span class="input-label">'+name+"</span>",c+='    <input type="text" ng-model="'+b+name+'" />',c+="</label>"):c+=buildhtml(d,b+name+"."),c+="</div>"}return c+="</div>"}function Workflow(a,b,c){return{name:c.name,doc:c.doc,states:c.states,transitions:c.transitions,init:function(){var d={ctx:null,name:c.name,doc:c.doc,states:c.states,transitions:c.transitions,onupdate:null},e=a.services[b].rpcs;return d.step=function(){e.workflow_step(d.ctx).then(function(a){LOGGING&&console.log("made-workflow-ctx:",a.data),d.ctx=a.data,d.onupdate&&d.onupdate(a)})},d.start=function(){e.workflow_start(c.name).then(function(a){LOGGING&&console.log("made-workflow-ctx:",a.data),d.ctx=a.data,d.onupdate&&d.onupdate(a)})},d.html=function(a){return d.ctx?d.ctx.template?d.ctx.template:buildhtml(d.ctx.data,a+".ctx.data."):""},d}}}function _arrayBufferToBase64(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)}function _base64ToArrayBuffer(a){var b=window.atob(a),c=b.length;console.log(c);for(var d=new Uint8Array(c),e=0;c>e;e++)d[e]=b.charCodeAt(e);return d}function File(a,b){var c={made:a,ctx:b,seek:0,data:null};return c.readAll=function(){var a=angular.injector(["ng"]),b=a.get("$q"),d=b.defer();return c.made.request("rpc://crm/file/read",[c.ctx.filename]).then(function(a){c.data=_base64ToArrayBuffer(a.data),console.log(c.data.length),d.resolve(c.data)}),d.promise},c.read=function(a,b){var d=angular.injector(["ng"]),e=d.get("$q"),f=e.defer();return c.made.request("rpc://crm/file/read",[c.ctx.filename,a,b]).then(function(a){f.resolve(a.data)}),f.promise},c.append=function(a){var b=angular.injector(["ng"]),d=b.get("$q"),e=d.defer();return c.made.request("rpc://crm/file/append",[c.ctx.filename,a]).then(function(a){c.ctx=a.data,e.resolve()}),c.data+=a,e.promise},c.store=function(){function f(a){if(a<c.data.byteLength){var b=c.data.slice(a,a+c.ctx.chunk_size),g=_arrayBufferToBase64(b);e.send(g),setTimeout(function(){f(a+c.ctx.chunk_size)},300)}else e.send("done-writing"),e.asyncRecv().then(function(a){LOGGING&&console.log("finished uploading"),c.ctx=a,d.resolve()})}var a=angular.injector(["ng"]),b=a.get("$q"),d=b.defer(),e=c.made.channel("file://crm/"+c.ctx.filename);return f(0),d.promise},c.save=function(){function a(){var a=document.createElement("a"),b=window.URL.createObjectURL(new Blob([c.data],{type:"octet/stream"}));if(a.setAttribute("href",b),a.setAttribute("download",c.ctx.filename),document.createEvent){var d=document.createEvent("MouseEvents");d.initEvent("click",!0,!0),a.dispatchEvent(d)}else a.click()}c.data?a():a()},c.remove=function(){c.made.request("rpc://crm/file/remove",[c.ctx.filename])},c}function Channel(a,b,c){var d=angular.injector(["ng"]),e={made:a,uri:b,context:c,buffer:[],q:d.get("$q"),listener:null,send:function(a){return e.made.send_with_context("channel",{type:"package","package":a},e.context)},recv:function(){return buffer.shift()},handleRecv:function(a){e.buffer.push(a),e.listener&&(e.listener.resolve(e.buffer.shift()),e.listener=null)},asyncRecv:function(){return e.listener=e.q.defer(),e.listener.promise},resolve:function(a){LOGGING&&console.log("channel-error",a.error),e.handleClose()},handleClose:function(){console.log("close channel "+e.context),delete e.made.contexts[e.context],e.listener&&e.listener.resolve(null)},close:function(){e.made.send_with_context("channel",{type:"close"},e.context),e.handleClose()}};return a.contexts[e.context]=e,a.send_with_context("channel",{type:"open",uri:b},e.context),e}var madejs=angular.module("made-js",["uuid4","ngCookies"],function(a){a.directive("madeCompile",function(a){return function(b,c,d){b.$watch(function(a){return a.$eval(d.madeCompile)},function(d){c.html(d),a(c.contents())(b)})}})}),LOGGING=!0;madejs.service("Made",function(a,b,c,d){function h(a,b){return{user:f.user,context:0,action:a,data:b,error:null,success:!0}}function i(a){function b(){LOGGING&&console.log("made - wait for connect"),setTimeout(function(){i(a)},500)}switch(g.readyState){case WebSocket.CONNECTING:b();break;case WebSocket.OPEN:a();break;default:LOGGING&&console.log("madejs: B\xc4HM, tring to send over a closed socket!")}}var e={},f=this,g=new WebSocket(url());this.user=c.get("user"),this.contexts=e,void 0==this.user&&(this.user=null),g.onopen=function(){LOGGING&&console.log("socket has made opened!")},g.onerror=function(a){console.log("madejs error: ",a)},g.onmessage=function(a){switch(a=JSON.parse(a.data),LOGGING&&console.log("-- received --",a),a.action){case"answer":a.context in e?(e[a.context].resolve(a),delete e[a.context]):LOGGING&&console.log("madejs error: message for unknown context");break;case"request":var b=a.data.path.join("."),c=subspaces[b],d=c(a.data.args,a.data.kwargs);answer(a,d,null);break;case"channel":switch(a.data.type){case"open":console.log("!!!FATAL!!! Opening channel to browser not allowed!");break;case"package":a.context in e?e[a.context].handleRecv(a.data.package):LOGGING&&console.log("package for unknown channel");break;case"close":a.context in e?e[a.context].handleClose():LOGGING&&console.log("close for unknown channel")}}},this.afterConnect=i,this.send=function(a,c){var g=b.defer(),h=d.generate();return e[h]=g,f.send_with_context(a,c,h),g.promise},this.send_with_context=function(a,b,c){var d=h(a,b);d.context=c,LOGGING&&console.log("-- sending --",d);var e=angular.toJson(d);i(function(){g.send(e)})},this.request=function(a,b,c){"undefined"==typeof b&&(b=[]),"undefined"==typeof c&&(c={});var d={uri:a,args:b,kwargs:c};return f.send("request",d)},this.channel=function(a){var b=Channel(f,a,d.generate());return b},this.topology=function(){var a=b.defer();return f.send("topology",{}).then(function(b){var c=b.data;a.resolve(c)}),a.promise},this.capabilities=function(){var a=b.defer();return f.send("capabilities").then(function(b){var c=b.data;a.resolve(c)}),a.promise},this.fileFromData=function(a,b){var c={filename:a,chunk_size:261120,length:b.byteLength,md5:"",encoding:"utf-8",meta:{}},d=File(f,c);return d.data=b,d},this.loginByName=function(a,d){var e=b.defer();return f.request("rpc://crm/user/login",[],{user:a,password:d}).then(function(a){a.success&&(f.user=a.data,c.put("user",f.user)),e.resolve(a)}),e.promise},this.loginByEmail=function(a,d){var e=b.defer();return f.request("rpc://crm/user/login",[],{email:a,password:d}).then(function(a){f.user=a.data,c.put("user",f.user),e.resolve(a)}),e.promise},this.logout=function(){f.user&&(f.request("rpc://crm/user/logout"),f.user=null,c.put("user",null))},this.isLoggedin=function(){return null!=f.user}}),madejs.directive("madeStoreFile",function($parse,Made){return{restrict:"A",scope:!1,link:function(scope,element,attrs){element.on("change",function(onChangeEvent){var element=onChangeEvent.srcElement||onChangeEvent.target,cmd="scope."+attrs.madeStoreFile+" = [];";LOGGING&&console.log(cmd),eval(cmd);for(var i=element.files.length-1;i>=0;i--){var current=element.files[i],reader=new FileReader;reader.onload=function(onLoadEvent){cmd="scope."+attrs.madeStoreFile+".push(Made.fileFromData(current.name, onLoadEvent.target.result));",LOGGING&&console.log(cmd),eval(cmd)},reader.readAsArrayBuffer(current)}})}}}),madejs.directive("madeTopology",function(){var a=640,b=480,c=d3.scale.category20(),d=d3.layout.force().charge(-120).linkDistance(60).size([a,b]);return{restrict:"E",scope:{data:"="},link:function(e,f){var h=d3.select(f[0]).append("svg").attr("width",a).attr("height",b),i=null,j=null;e.$watch("data",function(a){if(LOGGING&&console.log("made-topology nodes",a),h.selectAll("*").remove(),a){i=a.nodes,j=a.links,d.nodes(i),d.links(j),d.start();var e=h.selectAll(".topology-link").data(j).enter().append("line").attr("class","topology-link"),f=h.selectAll(".topology-node").data(i).enter().append("circle").attr("class","topology-node").attr("r",15).style("fill",function(a){return c(a.type)}).call(d.drag);d.on("tick",function(){e.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),f.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}})}}}),madejs.directive("madeTopologyLegend",function(){var a=d3.scale.category20();return{restrict:"E",scope:{data:"="},link:function(b,c){var e=d3.select(c[0]).append("div");b.$watch("data",function(b){LOGGING&&console.log("made-topology-legend nodes",b),e.selectAll("*").remove(),b&&e.selectAll("div").data(b.nodes).enter().append("div").text(function(a){return a.type}).append("div").attr("class","topology-legend-box").style("background-color",function(b){return a(b.type)})})}}});